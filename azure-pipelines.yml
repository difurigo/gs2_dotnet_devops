trigger:
  branches:
    include:
      - main   # Build só roda quando algo entra na main (via merge de PR)

pr:
  branches:
    include:
      - main   # Validação automática para Pull Requests que miram na main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  solution: 'Avant.sln'
  testsProject: 'Avant.Api.Tests/Avant.Api.Tests.csproj'

steps:
  # Garante que o SDK .NET 9 está disponível
  - task: UseDotNet@2
    displayName: 'Instalar .NET SDK 9'
    inputs:
      packageType: 'sdk'
      version: '9.0.x'
      performMultiLevelLookup: true

  # Restaura pacotes (poderia ser só dotnet restore, mas assim o professor vê bem organizado)
  - task: NuGetToolInstaller@1
    displayName: 'Instalar NuGet'

  - task: NuGetCommand@2
    displayName: 'Restaurar pacotes NuGet'
    inputs:
      restoreSolution: '$(solution)'

  # Build da solução inteira
  - task: DotNetCoreCLI@2
    displayName: 'Compilar solução'
    inputs:
      command: 'build'
      projects: '$(solution)'
      arguments: '--configuration $(buildConfiguration)'
      publishTestResults: false

  # Executa testes xUnit
  - task: DotNetCoreCLI@2
    displayName: 'Executar testes (xUnit)'
    inputs:
      command: 'test'
      projects: '$(testsProject)'
      arguments: '--configuration $(buildConfiguration) --logger trx'
      publishTestResults: false

  # Publica resultados dos testes (requisito: artefato de testes publicado)
  - task: PublishTestResults@2
    displayName: 'Publicar resultados de testes'
    condition: succeededOrFailed()    # publica mesmo se os testes falharem
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '**/TestResults/*.trx'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      testRunTitle: 'Avant API - Testes xUnit'

  # Publica o WebApp (gera o pacote para a Release)
  - task: DotNetCoreCLI@2
    displayName: 'Publicar aplicação (dotnet publish)'
    inputs:
      command: 'publish'
      publishWebProjects: true
      arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
      zipAfterPublish: true

  # Publica o artefato da build
  - task: PublishBuildArtifacts@1
    displayName: 'Publicar artefato de build'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop'
      publishLocation: 'Container'
